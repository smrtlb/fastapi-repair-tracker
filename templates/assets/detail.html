{% extends "base.html" %}

{% block title %}Asset Details - Repair Tracker{% endblock %}

{% block breadcrumbs %}
<nav class="bg-gray-800 px-4 py-3">
    <div class="max-w-7xl mx-auto">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a href="/" class="text-blue-400 hover:text-blue-300">Dashboard</a></li>
            <li class="text-gray-500">/</li>
            <li><a href="/assets" class="text-blue-400 hover:text-blue-300">Assets</a></li>
            <li class="text-gray-500">/</li>
            <li class="text-white" id="breadcrumb-asset-name">Asset Details</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div id="loading" class="text-center text-gray-400">
        Loading asset details...
    </div>
    
    <div id="asset-details" class="hidden">
        <!-- Asset Header -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-white" id="asset-name">-</h1>
                    <div class="mt-2 flex items-center space-x-4">
                        <span class="px-3 py-1 text-sm rounded-full bg-blue-900 text-blue-300" id="asset-type">-</span>
                        <span class="text-gray-400 text-sm" id="asset-created">-</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <a href="#" id="edit-link" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md">
                        Edit Asset
                    </a>
                    <button onclick="showDeleteModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">
                        Delete Asset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Repairs Section -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-white">Repairs</h2>
                <a href="#" id="new-repair-link" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                    Add Repair
                </a>
            </div>
            
            <div id="repairs-list">
                <div class="text-center text-gray-400">Loading repairs...</div>
            </div>
        </div>
    </div>
    
    <div id="not-found" class="hidden text-center py-12">
        <div class="text-gray-400 text-lg mb-4">Asset not found</div>
        <a href="/assets" class="text-blue-400 hover:text-blue-300">‚Üê Back to Assets</a>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-white mb-4">Confirm Delete</h3>
        <p class="text-gray-300 mb-6">Are you sure you want to delete this asset? This action cannot be undone and will also delete all associated repairs.</p>
        <div class="flex justify-end space-x-3">
            <button onclick="hideDeleteModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Cancel
            </button>
            <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md">
                Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAsset = null;
const assetId = {{ asset_id }};

document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    loadAssetDetails();
});

async function checkAuth() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const user = await response.json();
            document.getElementById('user-name').textContent = user.name || user.email;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
}

async function loadAssetDetails() {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/assets/${assetId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            currentAsset = await response.json();
            displayAssetDetails();
            loadRepairs();
        } else if (response.status === 404) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('not-found').classList.remove('hidden');
        } else if (response.status === 401) {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading asset details:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('not-found').classList.remove('hidden');
    }
}

function displayAssetDetails() {
    if (!currentAsset) return;
    
    document.getElementById('asset-name').textContent = currentAsset.name;
    document.getElementById('asset-type').textContent = currentAsset.type;
    document.getElementById('asset-created').textContent = `Created: ${formatDate(currentAsset.created_at)}`;
    document.getElementById('breadcrumb-asset-name').textContent = currentAsset.name;
    document.getElementById('edit-link').href = `/assets/${currentAsset.id}/edit`;
    document.getElementById('new-repair-link').href = `/repairs/new?asset_id=${currentAsset.id}`;
    
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('asset-details').classList.remove('hidden');
}

async function loadRepairs() {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/repairs?property_id=${assetId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const repairs = await response.json();
            displayRepairs(repairs);
        }
    } catch (error) {
        console.error('Error loading repairs:', error);
        document.getElementById('repairs-list').innerHTML = '<div class="text-center text-gray-400">Failed to load repairs</div>';
    }
}

function displayRepairs(repairs) {
    const container = document.getElementById('repairs-list');
    
    if (repairs.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400">No repairs found for this asset</div>';
        return;
    }
    
    const repairsHtml = repairs.map(repair => `
        <div class="bg-gray-700 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-2">
                        <h3 class="text-lg font-medium text-white">${repair.description}</h3>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            repair.status === 'COMPLETED' 
                                ? 'bg-green-900 text-green-300' 
                                : 'bg-yellow-900 text-yellow-300'
                        }">
                            ${repair.status}
                        </span>
                    </div>
                    <div class="text-sm text-gray-300 space-y-1">
                        <div><strong>Performed by:</strong> ${repair.performed_by}</div>
                        <div><strong>Date:</strong> ${formatDate(repair.date)}</div>
                        <div><strong>Cost:</strong> $${(repair.cost_cents / 100).toFixed(2)}</div>
                        ${repair.notes ? `<div><strong>Notes:</strong> ${repair.notes}</div>` : ''}
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <a href="/repairs/${repair.id}/edit" class="text-yellow-400 hover:text-yellow-300 text-sm">Edit</a>
                    <button onclick="deleteRepair(${repair.id})" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = repairsHtml;
}

function showDeleteModal() {
    document.getElementById('delete-modal').classList.remove('hidden');
    document.getElementById('delete-modal').classList.add('flex');
}

function hideDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    document.getElementById('delete-modal').classList.remove('flex');
}

async function confirmDelete() {
    if (!currentAsset) return;
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/assets/${currentAsset.id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            window.location.href = '/assets';
        } else {
            alert('Failed to delete asset');
        }
    } catch (error) {
        console.error('Error deleting asset:', error);
        alert('Failed to delete asset');
    }
}

async function deleteRepair(repairId) {
    if (!confirm('Are you sure you want to delete this repair?')) return;
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch(`/api/repairs/${repairId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            loadRepairs();
        } else {
            alert('Failed to delete repair');
        }
    } catch (error) {
        console.error('Error deleting repair:', error);
        alert('Failed to delete repair');
    }
}
</script>
{% endblock %}

