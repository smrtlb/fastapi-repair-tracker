{% extends "base.html" %}

{% block title %}Dashboard - Repair Tracker{% endblock %}

{% block breadcrumbs %}
<nav class="bg-gray-800 px-4 py-3">
    <div class="max-w-7xl mx-auto">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a href="/" class="text-blue-400 hover:text-blue-300">Dashboard</a></li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="border-4 border-dashed border-gray-600 rounded-lg p-8">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-white">Welcome to Repair Tracker</h1>
            <button id="refresh-dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <svg class="h-4 w-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            </button>
        </div>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-8 w-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-400">Total Assets</p>
                            <p class="text-2xl font-semibold text-white" id="total-assets">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-8 w-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-400">Completed Repairs</p>
                            <p class="text-2xl font-semibold text-white" id="completed-repairs">-</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Total Cost</p>
                        <p class="text-lg font-semibold text-green-400" id="completed-cost">$0.00</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-8 w-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-400">Planned Repairs</p>
                            <p class="text-2xl font-semibold text-white" id="planned-repairs">-</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Total Cost</p>
                        <p class="text-lg font-semibold text-yellow-400" id="planned-cost">$0.00</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-white mb-4">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <a href="/assets/new" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center">
                    <svg class="h-8 w-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Asset
                </a>
                <a href="/repairs/new" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center">
                    <svg class="h-8 w-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Repair
                </a>
                <a href="/assets" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center">
                    <svg class="h-8 w-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    View Assets
                </a>
                <a href="/repairs" class="bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-lg text-center">
                    <svg class="h-8 w-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    View Repairs
                </a>
            </div>
        </div>
        
        <!-- Import Data Card -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-white mb-4">Import Data</h2>
            <p class="text-gray-400 mb-6">Import your assets and repairs data from CSV files. Download templates below to get started.</p>
            
            <!-- Download Templates -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-2">Assets Template</h3>
                    <p class="text-gray-400 text-sm mb-3">Import your property and vehicle assets</p>
                    <a href="/api/templates/assets" download class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Assets Template
                    </a>
                </div>
                
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-2">Repairs Template</h3>
                    <p class="text-gray-400 text-sm mb-3">Import your repair records</p>
                    <a href="/api/templates/repairs" download class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download Repairs Template
                    </a>
                </div>
            </div>
            
            <!-- Import Forms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-2">Import Assets</h3>
                    <p class="text-gray-400 text-sm mb-3">Upload CSV file with your assets data</p>
                    <input type="file" id="assets-file" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('assets-file').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Choose Assets File
                    </button>
                    <div id="assets-import-result" class="mt-3 text-sm"></div>
                </div>
                
                <div class="bg-gray-700 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-white mb-2">Import Repairs</h3>
                    <p class="text-gray-400 text-sm mb-3">Upload CSV file with your repairs data</p>
                    <input type="file" id="repairs-file" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('repairs-file').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Choose Repairs File
                    </button>
                    <div id="repairs-import-result" class="mt-3 text-sm"></div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="mt-6 bg-gray-700 rounded-lg p-4">
                <h3 class="text-lg font-medium text-white mb-3">Import Instructions</h3>
                <div class="text-sm text-gray-400 space-y-2">
                    <p><strong>CSV Format:</strong> Use semicolon (;) as field separator</p>
                    <p><strong>Encoding:</strong> Save files in UTF-8 encoding</p>
                    <p><strong>Date Formats:</strong> YYYY-MM-DD, DD.MM.YYYY, DD/MM/YYYY, DD-MM-YYYY, MM/DD/YYYY, YYYY.MM.DD</p>
                    <p><strong>Cost Formats:</strong> 643.36, $150.50, €100.25, 25000 (cents)</p>
                    <p><strong>Required Fields:</strong> All fields are required except notes</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Repairs -->
        <div>
            <h2 class="text-xl font-semibold text-white mb-4">Recent Repairs</h2>
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div id="recent-repairs" class="p-4">
                    <div class="text-center text-gray-400">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Use currency functions from main.js
// Wait for main.js to load first

// Check authentication and load dashboard data
document.addEventListener('DOMContentLoaded', async function() {
    // Wait a bit for main.js to load
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        // Redirect to login if not authenticated
        window.location.href = '/login';
        return;
    }
    
    // Show user info
    try {
        const userResponse = await fetch('/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (userResponse.ok) {
            const user = await userResponse.json();
            document.getElementById('user-name').textContent = user.name || user.email;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
        }
    } catch (error) {
        console.error('Error loading user info:', error);
    }
    
    // Load dashboard statistics
    loadDashboardData();
    
    // Listen for storage changes (when settings are updated)
    window.addEventListener('storage', function(e) {
        if (e.key === 'access_token') {
            // Token changed, reload page
            window.location.reload();
        } else if (e.key === 'userSettings') {
            // Settings changed, reload dashboard data
            console.log('Settings changed in localStorage, reloading dashboard...');
            try {
                const newSettings = JSON.parse(e.newValue);
                window.userSettings = newSettings;
                loadDashboardData();
            } catch (error) {
                console.error('Error parsing settings from localStorage:', error);
            }
        }
    });
    
    // Also listen for custom settings update event
    window.addEventListener('settingsUpdated', function() {
        console.log('Settings updated, reloading dashboard data...');
        loadDashboardData();
    });
    
    // Add refresh button handler
    document.getElementById('refresh-dashboard').addEventListener('click', function() {
        console.log('Manual refresh triggered');
        loadDashboardData();
    });
});

async function loadDashboardData() {
    const token = localStorage.getItem('access_token');
    
    // Reload user settings first
    await loadUserSettingsFromAPI();
    
    // Also check localStorage for settings
    const storedSettings = localStorage.getItem('userSettings');
    if (storedSettings) {
        try {
            const settings = JSON.parse(storedSettings);
            window.userSettings = settings;
            console.log('Settings loaded from localStorage:', settings);
        } catch (error) {
            console.error('Error parsing settings from localStorage:', error);
        }
    }
    
    try {
        // Load assets count
        const assetsResponse = await fetch('/api/assets', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (assetsResponse.ok) {
            const assets = await assetsResponse.json();
            document.getElementById('total-assets').textContent = assets.length;
        }
        
        // Load repairs data
        const repairsResponse = await fetch('/api/repairs', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (repairsResponse.ok) {
            const repairs = await repairsResponse.json();
            const completed = repairs.filter(r => r.status === 'COMPLETED');
            const planned = repairs.filter(r => r.status === 'PLANNED');
            
            // Update counts
            document.getElementById('completed-repairs').textContent = completed.length;
            document.getElementById('planned-repairs').textContent = planned.length;
            
            // Calculate and display costs
            const completedCost = completed.reduce((sum, repair) => sum + repair.cost_cents, 0);
            const plannedCost = planned.reduce((sum, repair) => sum + repair.cost_cents, 0);
            
            // Format costs with user's currency symbol (no conversion)
            const formatCost = (cost) => {
                console.log('Formatting cost:', cost, 'User settings:', window.userSettings);
                if (window.userSettings && window.userSettings.currency) {
                    const CURRENCY_SYMBOLS = {
                        'USD': '$',
                        'EUR': '€',
                        'RUB': '₽',
                        'GBP': '£',
                        'JPY': '¥'
                    };
                    const symbol = CURRENCY_SYMBOLS[window.userSettings.currency] || '$';
                    const amount = (cost / 100).toFixed(2);
                    const formatted = `${symbol}${amount}`;
                    console.log('Formatted with user currency symbol:', formatted);
                    return formatted;
                }
                const fallback = `$${(cost / 100).toFixed(2)}`;
                console.log('Using fallback format:', fallback);
                return fallback;
            };
            
            document.getElementById('completed-cost').textContent = formatCost(completedCost);
            document.getElementById('planned-cost').textContent = formatCost(plannedCost);
            
            // Show recent repairs
            const recentRepairs = repairs.slice(0, 5);
            displayRecentRepairs(recentRepairs);
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function displayRecentRepairs(repairs) {
    const container = document.getElementById('recent-repairs');
    
    if (repairs.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400">No repairs found</div>';
        return;
    }
    
    const repairsHtml = repairs.map(repair => `
        <div class="flex items-center justify-between py-3 border-b border-gray-700 last:border-b-0">
            <div class="flex-1">
                <div class="flex items-center space-x-2">
                    <span class="text-white font-medium">${repair.description}</span>
                    <span class="px-2 py-1 text-xs rounded-full ${
                        repair.status === 'COMPLETED' 
                            ? 'bg-green-900 text-green-300' 
                            : 'bg-yellow-900 text-yellow-300'
                    }">
                        ${repair.status}
                    </span>
                </div>
                <div class="text-sm text-gray-400">
                    ${repair.performed_by} • ${formatDate(repair.date)}
                </div>
            </div>
            <div class="text-right">
                <div class="text-white font-medium">${formatRepairCost(repair.cost_cents)}</div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = repairsHtml;
}

// Load user settings from API
async function loadUserSettingsFromAPI() {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/profile/settings', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const settings = await response.json();
            window.userSettings = settings;
            console.log('User settings reloaded:', settings);
        }
    } catch (error) {
        console.error('Error reloading user settings:', error);
    }
}

// Format repair cost with user's currency symbol (no conversion)
function formatRepairCost(amountCents) {
    if (window.userSettings && window.userSettings.currency) {
        const CURRENCY_SYMBOLS = {
            'USD': '$',
            'EUR': '€',
            'RUB': '₽',
            'GBP': '£',
            'JPY': '¥'
        };
        const symbol = CURRENCY_SYMBOLS[window.userSettings.currency] || '$';
        const amount = (amountCents / 100).toFixed(2);
        return `${symbol}${amount}`;
    }
    // Fallback to default USD formatting
    return `$${(amountCents / 100).toFixed(2)}`;
}

// Import functionality
document.getElementById('assets-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        importAssets(file);
    }
});

document.getElementById('repairs-file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        importRepairs(file);
    }
});

async function importAssets(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const resultDiv = document.getElementById('assets-import-result');
    resultDiv.innerHTML = '<div class="text-yellow-400">Importing...</div>';
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/import/assets', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="text-green-400">
                    ✅ Import successful: ${result.successful_imports} assets imported, ${result.failed_imports} failed
                    ${result.errors.length > 0 ? '<br>Errors:<br>' + result.errors.map(e => '• ' + e).join('<br>') : ''}
                </div>
            `;
            // Refresh dashboard data
            loadDashboardData();
        } else {
            resultDiv.innerHTML = `<div class="text-red-400">❌ Import failed: ${result.detail}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-400">❌ Import error: ${error.message}</div>`;
    }
    
    // Clear file input
    document.getElementById('assets-file').value = '';
}

async function importRepairs(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const resultDiv = document.getElementById('repairs-import-result');
    resultDiv.innerHTML = '<div class="text-yellow-400">Importing...</div>';
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/import/repairs', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `
                <div class="text-green-400">
                    ✅ Import successful: ${result.successful_imports} repairs imported, ${result.failed_imports} failed
                    ${result.errors.length > 0 ? '<br>Errors:<br>' + result.errors.map(e => '• ' + e).join('<br>') : ''}
                </div>
            `;
            // Refresh dashboard data
            loadDashboardData();
        } else {
            resultDiv.innerHTML = `<div class="text-red-400">❌ Import failed: ${result.detail}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="text-red-400">❌ Import error: ${error.message}</div>`;
    }
    
    // Clear file input
    document.getElementById('repairs-file').value = '';
}
</script>
{% endblock %}

