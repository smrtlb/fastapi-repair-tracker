{% extends "base.html" %}

{% block title %}Profile - Repair Tracker{% endblock %}

{% block breadcrumbs %}
<nav class="bg-gray-800 px-4 py-3">
    <div class="max-w-7xl mx-auto">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a href="/" class="text-blue-400 hover:text-blue-300">Dashboard</a></li>
            <li class="text-gray-500">/</li>
            <li class="text-white">Profile</li>
        </ol>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8">User Profile</h1>
        
        <!-- Profile Tabs -->
        <div class="bg-gray-800 rounded-lg">
            <div class="border-b border-gray-700">
                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                    <button id="profile-tab" class="tab-button active py-4 px-1 border-b-2 border-blue-500 text-blue-400 font-medium text-sm">
                        Profile Information
                    </button>
                    <button id="password-tab" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium text-sm">
                        Change Password
                    </button>
                    <button id="settings-tab" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-400 hover:text-gray-300 font-medium text-sm">
                        App Settings
                    </button>
                </nav>
            </div>
            
            <!-- Profile Information Tab -->
            <div id="profile-content" class="tab-content p-6">
                <h2 class="text-xl font-semibold text-white mb-6">Profile Information</h2>
                
                <form id="profile-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-300 mb-2">
                                Full Name
                            </label>
                            <input type="text" id="profile-name" name="name"
                                   class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter your full name">
                        </div>
                        
                        <div>
                            <label for="profile-email" class="block text-sm font-medium text-gray-300 mb-2">
                                Email Address
                            </label>
                            <input type="email" id="profile-email" name="email"
                                   class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter your email">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Role
                            </label>
                            <div class="px-3 py-2 bg-gray-700 text-gray-300 rounded-md" id="profile-role">
                                Loading...
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                Member Since
                            </label>
                            <div class="px-3 py-2 bg-gray-700 text-gray-300 rounded-md" id="profile-created">
                                Loading...
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                            Update Profile
                        </button>
                    </div>
                </form>
                
                <div id="profile-error" class="hidden mt-4 bg-red-900 border border-red-700 text-red-100 px-4 py-3 rounded">
                    <span id="profile-error-text"></span>
                </div>
            </div>
            
            <!-- Change Password Tab -->
            <div id="password-content" class="tab-content p-6 hidden">
                <h2 class="text-xl font-semibold text-white mb-6">Change Password</h2>
                
                <form id="password-form" class="space-y-6 max-w-md">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-300 mb-2">
                            Current Password
                        </label>
                        <input type="password" id="current-password" name="current_password" required
                               class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter current password">
                    </div>
                    
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-300 mb-2">
                            New Password
                        </label>
                        <input type="password" id="new-password" name="new_password" required
                               class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Enter new password">
                    </div>
                    
                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-300 mb-2">
                            Confirm New Password
                        </label>
                        <input type="password" id="confirm-password" name="confirm_password" required
                               class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Confirm new password">
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md">
                            Change Password
                        </button>
                    </div>
                </form>
                
                <div id="password-error" class="hidden mt-4 bg-red-900 border border-red-700 text-red-100 px-4 py-3 rounded">
                    <span id="password-error-text"></span>
                </div>
            </div>
            
            <!-- App Settings Tab -->
            <div id="settings-content" class="tab-content p-6 hidden">
                <h2 class="text-xl font-semibold text-white mb-6">Application Settings</h2>
                
                <form id="settings-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="currency" class="block text-sm font-medium text-gray-300 mb-2">
                                Currency
                            </label>
                            <select id="currency" name="currency"
                                    class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="RUB">RUB - Russian Ruble</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="language" class="block text-sm font-medium text-gray-300 mb-2">
                                Language
                            </label>
                            <select id="language" name="language"
                                    class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="en">English</option>
                                <option value="ru">Русский</option>
                                <option value="de">Deutsch</option>
                                <option value="fr">Français</option>
                                <option value="es">Español</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="date-format" class="block text-sm font-medium text-gray-300 mb-2">
                                Date Format
                            </label>
                            <select id="date-format" name="date_format"
                                    class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="DD.MM.YYYY">DD.MM.YYYY (01.01.2024)</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY (01/01/2024)</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD (2024-01-01)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="theme" class="block text-sm font-medium text-gray-300 mb-2">
                                Theme
                            </label>
                            <select id="theme" name="theme"
                                    class="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="dark">Dark Theme</option>
                                <option value="light">Light Theme</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md">
                            Save Settings
                        </button>
                    </div>
                </form>
                
                <div id="settings-error" class="hidden mt-4 bg-red-900 border border-red-700 text-red-100 px-4 py-3 rounded">
                    <span id="settings-error-text"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let profileUser = null;
let currentSettings = null;

document.addEventListener('DOMContentLoaded', function() {
    setupTabs();
    
    // Form event listeners
    document.getElementById('profile-form').addEventListener('submit', updateProfile);
    document.getElementById('password-form').addEventListener('submit', changePassword);
    document.getElementById('settings-form').addEventListener('submit', updateSettings);
    
    // Load data after auth check
    checkAuth().then(() => {
        loadProfileData();
        loadSettings();
    });
});

function setupTabs() {
    const tabs = document.querySelectorAll('.tab-button');
    const contents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetId = this.id.replace('-tab', '-content');
            
            // Remove active class from all tabs
            tabs.forEach(t => {
                t.classList.remove('active', 'border-blue-500', 'text-blue-400');
                t.classList.add('border-transparent', 'text-gray-400');
            });
            
            // Hide all contents
            contents.forEach(c => c.classList.add('hidden'));
            
            // Activate clicked tab
            this.classList.add('active', 'border-blue-500', 'text-blue-400');
            this.classList.remove('border-transparent', 'text-gray-400');
            
            // Show target content
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }
        });
    });
}

async function checkAuth() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            profileUser = await response.json();
            document.getElementById('user-name').textContent = profileUser.name || profileUser.email;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
            return profileUser;
        } else {
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Error loading user info:', error);
        window.location.href = '/login';
    }
}

async function loadProfileData() {
    if (!profileUser) {
        return;
    }
    
    document.getElementById('profile-name').value = profileUser.name || '';
    document.getElementById('profile-email').value = profileUser.email;
    document.getElementById('profile-role').textContent = profileUser.role;
    document.getElementById('profile-created').textContent = formatDate(profileUser.created_at);
}

async function loadSettings() {
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/profile/settings', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            
            document.getElementById('currency').value = currentSettings.currency;
            document.getElementById('language').value = currentSettings.language;
            document.getElementById('date-format').value = currentSettings.date_format;
            document.getElementById('theme').value = currentSettings.theme;
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function updateProfile(e) {
    e.preventDefault();
    
    const name = document.getElementById('profile-name').value.trim();
    const email = document.getElementById('profile-email').value.trim();
    const errorDiv = document.getElementById('profile-error');
    const errorText = document.getElementById('profile-error-text');
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, email })
        });
        
        if (response.ok) {
            const updatedUser = await response.json();
            profileUser = updatedUser;
            document.getElementById('user-name').textContent = updatedUser.name || updatedUser.email;
            showSuccess('Profile updated successfully');
            errorDiv.classList.add('hidden');
        } else {
            const error = await response.json();
            errorText.textContent = error.detail || 'Failed to update profile';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        errorText.textContent = 'Network error. Please try again.';
        errorDiv.classList.remove('hidden');
    }
}

async function changePassword(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    const errorDiv = document.getElementById('password-error');
    const errorText = document.getElementById('password-error-text');
    
    if (newPassword !== confirmPassword) {
        errorText.textContent = 'New passwords do not match';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    if (newPassword.length < 6) {
        errorText.textContent = 'New password must be at least 6 characters long';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        });
        
        if (response.ok) {
            showSuccess('Password changed successfully');
            document.getElementById('password-form').reset();
            errorDiv.classList.add('hidden');
        } else {
            const error = await response.json();
            errorText.textContent = error.detail || 'Failed to change password';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error changing password:', error);
        errorText.textContent = 'Network error. Please try again.';
        errorDiv.classList.remove('hidden');
    }
}

async function updateSettings(e) {
    e.preventDefault();
    
    const currency = document.getElementById('currency').value;
    const language = document.getElementById('language').value;
    const dateFormat = document.getElementById('date-format').value;
    const theme = document.getElementById('theme').value;
    const errorDiv = document.getElementById('settings-error');
    const errorText = document.getElementById('settings-error-text');
    
    const token = localStorage.getItem('access_token');
    
    try {
        const response = await fetch('/api/profile/settings', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                currency,
                language,
                date_format: dateFormat,
                theme
            })
        });
        
        if (response.ok) {
            currentSettings = await response.json();
            showSuccess('Settings updated successfully');
            errorDiv.classList.add('hidden');
            
            // Apply theme change immediately
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
            
            // Update global settings and notify other pages
            if (window.userSettings) {
                window.userSettings = currentSettings;
            }
            
            // Store settings in localStorage for cross-tab communication
            localStorage.setItem('userSettings', JSON.stringify(currentSettings));
            
            // Dispatch custom event to notify other pages
            window.dispatchEvent(new CustomEvent('settingsUpdated', {
                detail: { settings: currentSettings }
            }));
        } else {
            const error = await response.json();
            errorText.textContent = error.detail || 'Failed to update settings';
            errorDiv.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error updating settings:', error);
        errorText.textContent = 'Network error. Please try again.';
        errorDiv.classList.remove('hidden');
    }
}

function showSuccess(message) {
    // Simple success display - you could enhance this with a proper notification system
    alert('Success: ' + message);
}
</script>
{% endblock %}
